<!DOCTYPE html>
<html>

<head>
  <title>APS Viewer Rooms Screenshots Sample</title>
  <meta charset="utf-8" />
  <link rel="shortcut icon" href="https://github.com/Autodesk-Forge/learn.forge.viewmodels/raw/master/img/favicon.ico">
  <!-- Common packages: Bootstrap, SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Autodesk Platform Services Viewer files -->
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css"
    type="text/css">
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <!-- Extension -->
  <script src="./RoomsImagesExtension.js"></script>
  <!-- this project files -->
  <style type="text/css">
    html,
    body {
      min-height: 100%;
      height: 100%;
    }

    body {
      padding-top: 5rem;
      /*space for the top nav bar*/
    }

    #apsViewer {
      width: 100%;
      height: calc(100vh - 5rem);
      position: relative;
    }

    .container {
      white-space: nowrap;
    }

    .logo {
      height: 1em;
      text-align: left;
    }

    .inline {
      display: inline-block;
      margin: 1vh;
    }
  </style>
</head>

<body onload="initAPSViewer('dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6dGV4dGdlb20tYmxvZy9PZmZpY2UucnZ0')">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <a href="http://developer.autodesk.com" class="navbar-brand" href="#"><img alt="Autodesk Platform Services"
          src="https://cdn.autodesk.io/logo/black/stacked.png" height="20"></a>
    </div>
  </nav>
  <!-- End of navbar -->
  <div class="container-fluid fill">
    <div class="row fill">
      <div id="apsViewer"></div>
    </div>
  </div>
  <form id="uploadFile" method='post' enctype="multipart/form-data">
    <input id="hiddenUploadField" type="file" name="theFile" style="visibility:hidden" />
  </form>
</body>

<script>

  // var viewer = null;
  var _access_token = null;
  // var viewObjs = null;

  async function getToken() {
    await fetch('https://lowlblo75l.execute-api.us-east-1.amazonaws.com/default/GetTokenWithAHub').then(response => {
      return response.json();
    }).then(data => {
      _access_token = data;
    });
  }

  async function initAPSViewer(urn) {
    await getToken();

    const options = {
      env: 'AutodeskProduction',
      accessToken: _access_token,
      isAEC: true
    };

    Autodesk.Viewing.Initializer(options, () => {
      const div = document.getElementById('apsViewer');

      const config = {
        extensions: ['RoomsImagesExtension', 'Autodesk.DocumentBrowser']
      };

      viewer = new Autodesk.Viewing.Private.GuiViewer3D(div, config);
      viewer.start();
      viewer.setTheme("light-theme");
      Autodesk.Viewing.Document.load(`urn:${urn}`, doc => {
        var masterViews = findMasterViews(doc.getRoot().findAllViewables()[0]);
        viewer.loadDocumentNode(doc,  /* if any master view */ masterViews.length !== 0 ? /* use first */ masterViews[0] : /* or use default */ doc.getRoot().getDefaultGeometry()).then(i => {
          // documented loaded, any action?
        });
      });

      function findMasterViews(viewable) {
        var masterViews = [];
        // master views are under the "folder" with this UUID
        if (viewable.data.type === 'folder' && viewable.data.name === '08f99ae5-b8be-4f8d-881b-128675723c10') {
          return viewable.children;
        }
        if (viewable.children === undefined) return;
        viewable.children.forEach((children) => {
          var mv = findMasterViews(children);
          if (mv === undefined || mv.length == 0) return;
          masterViews = masterViews.concat(mv);
        })
        return masterViews;
      }
    });
  }

  // async function generateThumbnail(viewObj) {
  //   await viewer.setViewFromArray(viewObj.viewpoint);
  //   let vw = viewer.container.clientWidth;
  //   let vh = viewer.container.clientHeight;
  //   viewer.getScreenShot(vw, vh, blob => {
  //     var image = new Image();
  //     image.src = blob;
  //     var tag = document.createElement('a');
  //     tag.href = blob;
  //     tag.download = "image.png";
  //     document.body.appendChild(tag);
  //     tag.click();
  //     document.body.removeChild(tag);
  //     let viewpointsCount = viewObjs.length;
  //     if (viewpointsCount > 0)
  //       viewer.setViewFromArray(viewObjs[viewpointsCount - 1].viewpoint);
  //   });
  // }

</script>

</html>